# Butler - 智能助手系统

Butler 是一个功能丰富的智能助手系统，使用 Python 开发。它集成了自然语言处理、强大的算法库、动态程序管理、沙盒代码解释器以及可扩展的插件系统。Butler 采用模块化架构设计，能够通过文本、语音或 API 命令执行各种复杂任务。

该项目还包含一个全面的常用算法库，并通过开发者友好的 REST API 公开它们，使其可以从任何编程语言访问。

## 功能特性

*   **对话式 AI**：使用 DeepSeek API 进行自然语言理解和响应生成。
*   **可扩展的程序管理**：动态加载和执行外部程序模块。
*   **高级算法库**：丰富、高效且文档齐全的算法库。
*   **开发者友好 API**：用于直接访问算法库的专用 REST API。
*   **交互式命令面板**：基于 Tkinter 的 GUI，用于文本交互。
*   **语音交互**：支持语音命令，并使用 Azure 认知服务进行语音合成。
*   **本地代码解释器**：一个安全、沙盒化的环境，用于执行从自然语言命令生成的 Python 代码。
*   **插件系统**：使用自定义插件轻松扩展 Butler 的功能。
*   **单片机集成**：支持通过 MQTT 接入 ESP32 等单片机作为硬件终端（参见 [EMBEDDED_GUIDE.md](EMBEDDED_GUIDE.md)）。

## 架构设计

Butler 助手建立在模块化且可扩展的架构之上，旨在实现灵活性和可伸缩性。其核心是 `Jarvis` 类，它充当中央编排器，管理信息流并协调系统的各个组件。

关键架构组件包括：

*   **命令处理**：通过支持多条执行路径的高级命令处理系统处理用户输入。简单的命令可以由 `Jarvis` 类直接处理，而更复杂的查询则路由到适当的子系统。系统默认使用强大的本地代码解释器，但也提供 `/legacy` 命令来访问旧的基于意图的系统。

*   **本地代码解释器**：对于高级命令，Butler 使用沙盒化的本地解释器，可以执行从自然语言生成的 Python 代码。该组件封装在 `Interpreter` 类中，它利用 `Orchestrator` 生成代码，并利用 `code_executor` 在安全环境中运行代码。

*   **插件系统**：Butler 的功能可以通过动态插件系统进行扩展。`PluginManager` 负责发现、加载和执行 `plugin/` 目录中的插件。每个插件都是一个独立的模块，可以设计用于执行特定任务，例如搜索网络、管理待办事项列表或与外部 API 交互。

*   **包管理**：`package/` 目录包含助手可以调用的独立工具和实用程序。这些包是动态发现的，可以作为独立程序执行，为系统添加新功能提供了一种简单的方法。

*   **用户界面**：主要用户界面是基于 Tkinter 的 GUI，由 `CommandPanel` 类管理。该组件提供了一个用于与助手交互的文本界面，并可以扩展以支持其他形式的交互，例如语音命令。

这种模块化设计允许对每个组件进行独立开发和测试，使系统易于维护和扩展。

## 命令处理工作流

用户命令通过灵活且多层的工作流进行处理，以确保由适当的组件处理请求。默认处理路径是本地代码解释器，但用户可以通过在命令前添加 `/legacy` 前缀来访问旧的基于意图的系统。

工作流如下：

1.  **输入**：用户通过 Tkinter GUI、语音输入或其他界面输入命令。

2.  **路由**：
    *   如果命令以 `/legacy` 开头，它将被路由到旧的基于意图的系统。系统使用 DeepSeek API 执行自然语言理解 (NLU) 并识别用户的意图和任何关联的实体。然后，根据识别出的意图将命令传递给适当的处理程序。
    *   否则，命令默认发送到**本地代码解释器**。

3.  **执行**：
    *   **本地解释器**：`Interpreter` 类将自然语言命令发送到 `Orchestrator`，后者使用 LLM 生成 Python 代码。然后，该代码由 `code_executor` 在安全、沙盒化的环境中执行。
    *   **旧版系统**：如果匹配到意图，则调用 `Jarvis` 类中相应的处理程序。这可能涉及调用 `algorithms` 库中的函数、与插件交互或执行包。
    *   **插件执行**：如果命令旨在用于插件，`PluginManager` 将识别正确的插件并执行其 `run` 方法。
    *   **包执行**：如果命令对应于包，`Jarvis` 类将执行包的 `run()` 函数。

4.  **输出**：命令执行的结果通过 GUI 显示给用户，并在适用时使用文本转语音功能播报给用户。

这种分层方法允许 Butler 处理从预定义的简单操作到复杂的动态生成代码的各种命令，同时保持清晰且有条理的结构。

## 项目结构

项目分为几个关键目录，每个目录都有特定的角色：

*   `butler/`：Butler 助手的核心。此目录包含主应用程序逻辑，包括编排整个系统的 `Jarvis` 类。它还包含基于 Tkinter 的 GUI (`CommandPanel.py`)、对话式 AI 集成以及算法库的 REST API。

*   `local_interpreter/`：一个独立的、沙盒化的代码解释器。该组件负责安全地执行从自然语言命令生成的 Python 代码。它具有一个将自然语言转换为代码的 `Orchestrator` 和一个在安全环境中运行代码的 `Executor`，防止其影响宿主系统。

*   `package/`：Butler 助手可以调用的独立模块和工具的集合。此目录中的每个 `.py` 文件都被视为一个单独的包，并且必须包含一个 `run()` 函数才能执行。这使得使用新的、独立的工具轻松扩展 Butler 的功能成为可能。

*   `plugin/`：用于创建和管理插件以扩展 Butler 核心功能的框架。插件比包集成得更深，并由 `PluginManager` 管理。它们必须继承自 `AbstractPlugin`，并可用于添加复杂功能，如网络搜索、长期记忆或与外部服务交互。

*   `logs/`：包含应用程序的日志文件，对于调试和监视系统行为非常有用。

## 快速入门

### 安装

1.  **克隆仓库：**
    ```bash
    git clone https://github.com/PAYDAY3/Butler.git
    cd Butler
    ```

2.  **创建虚拟环境（推荐）：**
    ```bash
    python -m venv venv
    source venv/bin/activate  # 在 Windows 上，使用 `venv\Scripts\activate`
    ```

3.  **安装依赖：**
    ```bash
    pip install -r requirements.txt
    ```

4.  **配置 API 密钥：**
    通过复制 `.env.example` 文件在根目录下创建一个 `.env` 文件。然后，添加你的 API 密钥：
    ```
    DEEPSEEK_API_KEY="你的_deepseek_api_密钥"
    AZURE_SPEECH_KEY="你的_azure_speech_密钥"
    AZURE_SERVICE_REGION="你的_azure_服务区域"
    ```

## 使用方法

### 快速启动（推荐）

安装依赖并配置 API 密钥后，你可以轻松启动应用程序：

*   **Windows 用户：** 只需双击 `run.bat` 文件。
*   **macOS 或 Linux 用户：** 从终端使用 `./run.sh` 运行 `run.sh` 脚本，或者在文件管理器中双击它（你可能需要先使用 `chmod +x run.sh` 授予其执行权限）。

这些脚本将打开带有图形用户界面的主应用程序。

### 手动启动

如果你愿意，仍然可以从命令行手动运行应用程序。

#### Butler 助手

启动带有 GUI 的 Butler 助手：

```bash
python -m butler.main
```

你可以通过在输入框中输入命令或使用语音命令与助手交互。

### 本地解释器

运行独立的本地代码解释器：

```bash
python -m local_interpreter.main
```

这将启动一个命令行界面，你可以在其中输入要在沙盒环境中执行的自然语言命令。

### 算法 API

启动算法库的 REST API 服务器：

```bash
python -m butler.api
```

服务器将在 `http://localhost:5001` 上运行。然后，你可以向可用的端点（例如 `/api/sort`, `/api/search`）发起请求。

## 包 (Packages)

`package/` 目录包含 Butler 助手可以执行的工具和实用程序。此目录中的每个模块都应该有一个 `run()` 函数，作为执行的入口点。

要添加新包，只需在 `package/` 目录中创建一个新的 Python 文件，并在其中实现 `run()` 函数。Butler 将自动发现并能够执行它。

## 插件 (Plugins)

`plugin/` 目录包含扩展 Butler 助手功能的插件。每个插件都应该继承自 `plugin.abstract_plugin.AbstractPlugin` 并实现所需的方法。

`PluginManager` 将自动加载放置在此目录中的任何有效插件。

## 贡献

我们欢迎任何形式的贡献！请随时提交 Pull Request。贡献时，请确保你的代码符合项目的风格，并在适当的地方更新文档。

## 开源协议

本项目采用 MIT 协议。有关详细信息，请参阅 `LICENSE` 文件。
